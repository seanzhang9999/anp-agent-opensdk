<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANP Open SDK 架构设计方案</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2, h3, h4 {
            color: #2c3e50;
        }
        h1 {
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 8px;
            margin-top: 30px;
        }
        h3 {
            color: #34495e;
            margin-top: 25px;
        }
        .architecture-diagram {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: center;
        }
        .code-block {
            background-color: #f4f4f4;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 15px 0;
            overflow-x: auto;
            font-family: 'Courier New', Courier, monospace;
        }
        .feature-box {
            background-color: #e8f4f8;
            border: 1px solid #b8e0e8;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .warning-box {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #3498db;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .toc {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 30px;
        }
        .toc h3 {
            margin-top: 0;
        }
        .toc ul {
            list-style-type: none;
            padding-left: 20px;
        }
        .toc a {
            color: #3498db;
            text-decoration: none;
        }
        .toc a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ANP Open SDK 架构设计方案</h1>
        
        <div class="toc">
            <h3>目录</h3>
            <ul>
                <li><a href="#overview">1. 概述</a></li>
                <li><a href="#architecture">2. 整体架构</a></li>
                <li><a href="#protocol-design">3. 协议层设计</a></li>
                <li><a href="#scenario-adaptation">4. 场景自适应设计</a></li>
                <li><a href="#transport-routing">5. 传输路由层</a></li>
                <li><a href="#security">6. 安全存储设计</a></li>
                <li><a href="#implementation">7. 实现细节</a></li>
            </ul>
        </div>

        <h2 id="overview">1. 概述</h2>
        <p>ANP Open SDK 是一个分布式智能体网络SDK，提供了完整的智能体创建、发现、通信和协作能力。本设计方案基于模块化、可扩展的架构理念，支持多种部署场景和协议互通。</p>

        <h3>1.1 核心目标</h3>
        <ul>
            <li><strong>统一接口</strong>：不同场景使用相同的SDK接口</li>
            <li><strong>协议互通</strong>：支持ANP、A2A、MCP等多种协议</li>
            <li><strong>智能路由</strong>：自动选择最优传输路径</li>
            <li><strong>安全可靠</strong>：提供加密存储和身份验证</li>
            <li><strong>易于扩展</strong>：清晰的分层架构便于添加新功能</li>
        </ul>

        <h2 id="architecture">2. 整体架构</h2>
        
        <div class="architecture-diagram">
            <h4>系统架构图</h4>
            <svg width="800" height="600" viewBox="0 0 800 600" xmlns="http://www.w3.org/2000/svg">
                <!-- 应用层 -->
                <g id="app-layer">
                    <rect x="50" y="20" width="700" height="80" fill="#3498db" stroke="#2980b9" stroke-width="2" rx="5"/>
                    <text x="400" y="45" text-anchor="middle" fill="white" font-size="16" font-weight="bold">应用层 (Application)</text>
                    <rect x="100" y="55" width="150" height="35" fill="white" stroke="#2980b9" rx="3"/>
                    <text x="175" y="78" text-anchor="middle" font-size="14">Local Agent</text>
                    <rect x="300" y="55" width="150" height="35" fill="white" stroke="#2980b9" rx="3"/>
                    <text x="375" y="78" text-anchor="middle" font-size="14">Agent Builder</text>
                    <rect x="500" y="55" width="150" height="35" fill="white" stroke="#2980b9" rx="3"/>
                    <text x="575" y="78" text-anchor="middle" font-size="14">SDK Interface</text>
                </g>
                
                <!-- 协议层 -->
                <g id="protocol-layer">
                    <rect x="50" y="120" width="700" height="100" fill="#9b59b6" stroke="#8e44ad" stroke-width="2" rx="5"/>
                    <text x="400" y="145" text-anchor="middle" fill="white" font-size="16" font-weight="bold">协议层 (Protocol)</text>
                    
                    <!-- Agent协议组 -->
                    <rect x="80" y="160" width="300" height="50" fill="#e8d5f2" stroke="#8e44ad" rx="3"/>
                    <text x="230" y="180" text-anchor="middle" font-size="13">Agent Protocols</text>
                    <rect x="100" y="185" width="60" height="20" fill="white" stroke="#8e44ad" rx="2"/>
                    <text x="130" y="198" text-anchor="middle" font-size="11">ANP</text>
                    <rect x="170" y="185" width="60" height="20" fill="white" stroke="#8e44ad" rx="2"/>
                    <text x="200" y="198" text-anchor="middle" font-size="11">A2A</text>
                    <rect x="240" y="185" width="60" height="20" fill="white" stroke="#8e44ad" rx="2"/>
                    <text x="270" y="198" text-anchor="middle" font-size="11">...</text>
                    
                    <!-- Context协议组 -->
                    <rect x="420" y="160" width="300" height="50" fill="#e8d5f2" stroke="#8e44ad" rx="3"/>
                    <text x="570" y="180" text-anchor="middle" font-size="13">Context Protocols</text>
                    <rect x="470" y="185" width="60" height="20" fill="white" stroke="#8e44ad" rx="2"/>
                    <text x="500" y="198" text-anchor="middle" font-size="11">MCP</text>
                    <rect x="540" y="185" width="60" height="20" fill="white" stroke="#8e44ad" rx="2"/>
                    <text x="570" y="198" text-anchor="middle" font-size="11">...</text>
                </g>
                
                <!-- 传输路由层 -->
                <g id="transport-layer">
                    <rect x="50" y="240" width="700" height="120" fill="#e67e22" stroke="#d35400" stroke-width="2" rx="5"/>
                    <text x="400" y="265" text-anchor="middle" fill="white" font-size="16" font-weight="bold">传输路由层 (Transport)</text>
                    
                    <rect x="100" y="280" width="180" height="30" fill="white" stroke="#d35400" rx="3"/>
                    <text x="190" y="300" text-anchor="middle" font-size="13">Transport Router</text>
                    
                    <rect x="320" y="280" width="180" height="30" fill="white"  stroke="#d35400" rx="3"/>
                    <text x="410" y="300" text-anchor="middle" font-size="13">Transport Manager</text>
                    
                    <!-- 传输适配器 -->
                    <rect x="80" y="320" width="80" height="25" fill="#fdebd7" stroke="#d35400" rx="2"/>
                    <text x="120" y="338" text-anchor="middle" font-size="11">Local</text>
                    <rect x="180" y="320" width="80" height="25" fill="#fdebd7" stroke="#d35400" rx="2"/>
                    <text x="220" y="338" text-anchor="middle" font-size="11">HTTP</text>
                    <rect x="280" y="320" width="80" height="25" fill="#fdebd7" stroke="#d35400" rx="2"/>
                    <text x="320" y="338" text-anchor="middle" font-size="11">WebSocket</text>
                    <rect x="380" y="320" width="80" height="25" fill="#fdebd7" stroke="#d35400" rx="2"/>
                    <text x="420" y="338" text-anchor="middle" font-size="11">gRPC</text>
                    <rect x="480" y="320" width="80" height="25" fill="#fdebd7" stroke="#d35400" rx="2"/>
                    <text x="520" y="338" text-anchor="middle" font-size="11">IPC</text>
                </g>
                
                <!-- 核心服务层 -->
                <g id="core-layer">
                    <rect x="50" y="380" width="700" height="80" fill="#16a085" stroke="#138d75" stroke-width="2" rx="5"/>
                    <text x="400" y="405" text-anchor="middle" fill="white" font-size="16" font-weight="bold">核心服务 (Core Services)</text>
                    
                    <rect x="100" y="420" width="120" height="30" fill="white" stroke="#138d75" rx="3"/>
                    <text x="160" y="440" text-anchor="middle" font-size="12">DID</text>
                    <rect x="240" y="420" width="120" height="30" fill="white" stroke="#138d75" rx="3"/>
                    <text x="300" y="440" text-anchor="middle" font-size="12">Discovery</text>
                    <rect x="380" y="420" width="120" height="30" fill="white" stroke="#138d75" rx="3"/>
                    <text x="440" y="440" text-anchor="middle" font-size="12">Messaging</text>
                    <rect x="520" y="420" width="120" height="30" fill="white" stroke="#138d75" rx="3"/>
                    <text x="580" y="440" text-anchor="middle" font-size="12">Group Service</text>
                </g>
                
                <!-- 存储层 -->
                <g id="storage-layer">
                    <rect x="50" y="480" width="700" height="80" fill="#34495e" stroke="#2c3e50" stroke-width="2" rx="5"/>
                    <text x="400" y="505" text-anchor="middle" fill="white" font-size="16" font-weight="bold">存储层 (Storage)</text>
                    
                    <rect x="200" y="520" width="180" height="30" fill="white" stroke="#2c3e50" rx="3"/>
                    <text x="290" y="540" text-anchor="middle" font-size="12">Secure Storage</text>
                    <rect x="420" y="520" width="180" height="30" fill="white" stroke="#2c3e50" rx="3"/>
                    <text x="510" y="540" text-anchor="middle" font-size="12">Cache Manager</text>
                </g>
                
                <!-- 连接线 -->
                <g id="connections" opacity="0.3">
                    <line x1="400" y1="100" x2="400" y2="120" stroke="#333" stroke-width="2"/>
                    <line x1="400" y1="220" x2="400" y2="240" stroke="#333" stroke-width="2"/>
                    <line x1="400" y1="360" x2="400" y2="380" stroke="#333" stroke-width="2"/>
                    <line x1="400" y1="460" x2="400" y2="480" stroke="#333" stroke-width="2"/>
                </g>
            </svg>
        </div>

        <h3>2.1 模块职责</h3>
        <table>
            <tr>
                <th>模块</th>
                <th>职责</th>
                <th>主要组件</th>
            </tr>
            <tr>
                <td>应用层</td>
                <td>提供用户接口和场景适配</td>
                <td>LocalAgent, AgentBuilder, 场景配置</td>
            </tr>
            <tr>
                <td>协议层</td>
                <td>处理不同协议的语义和转换</td>
                <td>AgentProtocol, ContextProtocol, ProtocolManager</td>
            </tr>
            <tr>
                <td>传输路由层</td>
                <td>智能路由决策和传输执行</td>
                <td>TransportRouter, TransportManager, 各种Adapter</td>
            </tr>
            <tr>
                <td>核心服务</td>
                <td>提供基础能力</td>
                <td>DID管理, 服务发现, 消息系统, 群组服务</td>
            </tr>
            <tr>
                <td>存储层</td>
                <td>数据持久化和安全存储</td>
                <td>SecureStorage, CacheManager</td>
            </tr>
        </table>

        <h2 id="protocol-design">3. 协议层设计</h2>

        <h3>3.1 协议分类</h3>
        <div class="feature-box">
            <h4>Agent协议</h4>
            <p>用于智能体之间的通信和协作</p>
            <ul>
                <li><strong>ANP (Agent Network Protocol)</strong>: 原生协议，支持完整功能</li>
                <li><strong>A2A (Agent to Agent)</strong>: 任务导向的agent协议</li>
                <li><strong>其他</strong>: 可扩展支持更多agent协议</li>
            </ul>
        </div>

        <div class="feature-box">
            <h4>Context协议</h4>
            <p>用于工具调用和上下文管理</p>
            <ul>
                <li><strong>MCP (Model Context Protocol)</strong>: Claude等模型使用的上下文协议</li>
                <li><strong>其他</strong>: 可扩展支持更多工具协议</li>
            </ul>
        </div>

        <h3>3.2 协议适配器设计</h3>
        <div class="code-block">
            <pre>
# Agent协议基类
class AgentProtocol(BaseProtocol):
    - discover_agents()
    - get_agent_capabilities()
    - call_agent_api()
    - send_message_to_agent()
    - publish_agent()
    - establish_connection()
    - verify_agent_identity()

# Context协议基类
class ContextProtocol(BaseProtocol):
    - list_tools()
    - call_tool()
    - get_context()
    - update_context()
    - register_tool()
    - get_tool_schema()
            </pre>
        </div>

        <h2 id="scenario-adaptation">4. 场景自适应设计</h2>

        <h3>4.1 支持的部署场景</h3>
        <table>
            <tr>
                <th>场景</th>
                <th>描述</th>
                <th>配置特点</th>
            </tr>
            <tr>
                <td>单个本地使用</td>
                <td>单机运行，无网络功能</td>
                <td>最小化配置，无服务器组件</td>
            </tr>
            <tr>
                <td>本地多Agent</td>
                <td>本地多个agent互相调用</td>
                <td>启用本地服务器和发现</td>
            </tr>
            <tr>
                <td>混合模式</td>
                <td>本地agent调用远程服务</td>
                <td>支持本地和远程发现</td>
            </tr>
            <tr>
                <td>公共服务</td>
                <td>对外提供网络服务</td>
                <td>公网服务器，身份验证</td>
            </tr>
            <tr>
                <td>漫游设备</td>
                <td>移动设备，动态IP</td>
                <td>SSE监听，反向代理</td>
            </tr>
            <tr>
                <td>内网设备</td>
                <td>企业内网服务</td>
                <td>WebSocket隧道</td>
            </tr>
            <tr>
                <td>群组成员</td>
                <td>私密群组协作</td>
                <td>群组加密通信</td>
            </tr>
        </table>

        <h3>4.2 自适应初始化</h3>
        <div class="code-block">
            <pre>
# 简单场景
agent = await create_agent(DeploymentMode.SINGLE_LOCAL, name="my_agent")

# 复杂场景
agent = await create_agent(
    DeploymentMode.ROAMING_DEVICE,
    name="mobile_agent",
    registry_url="https://registry.anp.network",
    reverse_proxy_config={
        "server": "wss://proxy.anp.network"
    }
)
            </pre>
        </div>

        <h2 id="transport-routing">5. 传输路由层</h2>

        <h3>5.1 智能路由机制</h3>
        <div class="architecture-diagram">
            <h4>路由决策流程</h4>
            <svg width="600" height="400" viewBox="0 0 600 400" xmlns="http://www.w3.org/2000/svg">
                <!-- 开始节点 -->
                <rect x="250" y="10" width="100" height="40" fill="#3498db" stroke="#2980b9" stroke-width="2" rx="20"/>
                <text x="300" y="35" text-anchor="middle" fill="white" font-size="14">请求发起</text>
                
                <!-- 路由器 -->
                <rect x="225" y="80" width="150" height="40" fill="#e74c3c" stroke="#c0392b" stroke-width="2" rx="5"/>
                <text x="300" y="105" text-anchor="middle" fill="white" font-size="14">TransportRouter</text>
                
                <!-- 决策菱形 -->
                <path d="M 300 150 L 350 180 L 300 210 L 250 180 Z" fill="#f39c12" stroke="#d35400" stroke-width="2"/>
                <text x="300" y="185" text-anchor="middle" font-size="12">本地Agent?</text>
                
                <!-- 本地分支 -->
                <rect x="100" y="240" width="120" height="40" fill="#27ae60" stroke="#229954" stroke-width="2" rx="5"/>
                <text x="160" y="265" text-anchor="middle" fill="white" font-size="13">Local Adapter</text>
                
                <!-- 远程分支 -->
                <path d="M 450 240 L 500 270 L 450 300 L 400 270 Z" fill="#f39c12" stroke="#d35400" stroke-width="2"/>
                <text x="450" y="275" text-anchor="middle" font-size="12">查询路由表</text>
                
                <!-- 结果节点 -->
                <rect x="250" y="340" width="100" height="40" fill="#16a085" stroke="#138d75" stroke-width="2" rx="20"/>
                <text x="300" y="365" text-anchor="middle" fill="white" font-size="14">执行传输</text>
                
                <!-- 连接线 -->
                <line x1="300" y1="50" x2="300" y2="80" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
                <line x1="300" y1="120" x2="300" y2="150" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
                <line x1="250" y1="180" x2="160" y2="240" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
                <text x="200" y="210" font-size="12">是</text>
                <line x1="350" y1="180" x2="450" y2="240" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
                <text x="400" y="210" font-size="12">否</text>
                <line x1="160" y1="280" x2="300" y2="340" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
                <line x1="450" y1="300" x2="300" y2="340" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
                
                <!-- 箭头定义 -->
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#333"/>
                    </marker>
                </defs>
            </svg>
        </div>

        <h3>5.2 传输协议支持</h3>
        <ul>
            <li><strong>Local</strong>: 内存直接调用，零延迟</li>
            <li><strong>HTTP/REST</strong>: 标准Web API</li>
            <li><strong>WebSocket</strong>: 双向实时通信</li>
            <li><strong>gRPC</strong>: 高性能RPC（可选）</li>
            <li><strong>IPC</strong>: 进程间通信（可选）</li>
        </ul>

        <h2 id="security">6. 安全存储设计</h2>

        <h3>6.1 安全级别</h3>
        <div class="warning-box">
            <h4>⚠️ 安全提示</h4>
            <p>生产环境必须使用加密存储，明文存储仅用于开发测试！</p>
        </div>

        <table>
            <tr>
                <th>安全级别</th>
                <th>适用场景</th>
                <th>特点</th>
            </tr>
            <tr>
                <td>PLAIN</td>
                <td>开发测试</td>
                <td>明文存储，方便调试</td>
            </tr>
            <tr>
                <td>ENCRYPTED</td>
                <td>生产环境</td>
                <td>AES-256加密，PBKDF2密钥派生</td>
            </tr>
            <tr>
                <td>HARDWARE</td>
                <td>高安全要求</td>
                <td>硬件安全模块(HSM)</td>
            </tr>
            <tr>
                <td>SECURE_ENCLAVE</td>
                <td>最高安全</td>
                <td>可信执行环境(TEE)</td>
            </tr>
        </table>

        <h3>6.2 存储内容</h3>
        <ul>
            <li>DID文档</li>
            <li>公私钥对</li>
            <li>服务凭证</li>
            <li>会话密钥</li>
        </ul>

        <h2 id="implementation">7. 实现细节</h2>

        <h3>7.1 核心功能特性</h3>
        <div class="feature-box">
            <h4>✅ 已实现功能</h4>
            <ul>
                <li>基础Agent创建和管理</li>
                <li>DID身份系统</li>
                <li>服务发现和注册</li>
                <li>API调用和消息传递</li>
                <li>群组功能</li>
                <li>本地加速优化</li>
            </ul>
        </div>

        <div class="feature-box">
            <h4>🔄 待实现功能</h4>
            <ul>
                <li>完整的协议适配器实现</li>
                <li>加密存储实现</li>
                <li>反向代理和隧道</li>
                <li>高级路由策略</li>
                <li>性能监控和优化</li>
            </ul>
        </div>

        <h3>7.2 扩展点</h3>
        <ul>
            <li><strong>新协议支持</strong>: 实现Protocol基类即可</li>
            <li><strong>新传输方式</strong>: 实现TransportAdapter即可</li>
            <li><strong>新存储后端</strong>: 实现SecureStorageProvider即可</li>
            <li><strong>新场景模式</strong>: 添加ProfileConfig即可</li>
        </ul>

        <hr>
        <p style="text-align: center; color: #666;">
            ANP Open SDK 架构设计方案 v1.0<br>
            更新时间：2024年
        </p>
    </div>
</body>
</html>